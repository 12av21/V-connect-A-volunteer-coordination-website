<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Dashboard - V-Connect</title>
    <link rel="icon" href="../assets/v1.png" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css//volunteer/dashboard.css">


</head>

<body>
    <nav class="sidebar">
        <a href="dashboard.html" class="sidebar-logo">
            <i class="fas fa-hands-helping"></i>
            <span>V-Connect</span>
        </a>
        <div class="nav flex-column">
            <a href="dashboard.html" class="nav-link active">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user"></i> Profile
            </a>
            <a href="opportunities.html" class="nav-link">
                <i class="fas fa-search"></i> Find Opportunities
            </a>
            <a href="myevents.html" class="nav-link">
                <i class="fas fa-calendar"></i> My Events
            </a>
            <a href="leaderboard.html" class="nav-link ">
                <i class="fas fa-trophy"></i> Leaderboard
            </a>
            <a href="../home/writeblogs.html" class="nav-link ">
                <i class="fas fa-blog"></i> Blogs
            </a>
            <a href="#" class="nav-link" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>
    <div class="main-content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 id="welcomeMessage">Welcome back, <span id="volunteerName">Volunteer</span>!</h2>
                    <p class="text-muted">Here's your volunteering overview</p>
                </div>
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stats-value" id="totalHours">0</div>
                        <div class="stats-label">Volunteer Hours</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stats-value" id="eventsAttended">0</div>
                        <div class="stats-label">Events Attended</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stats-value" id="totalPoints">0</div>
                        <div class="stats-label">Total Points</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-medal"></i>
                        </div>
                        <div class="stats-value" id="badgesEarned">0</div>
                        <div class="stats-label">Badges Earned</div>
                    </div>
                </div>
            </div>
            <div class="quick-actions">
                <div class="action-card" onclick="window.location.href='opportunities.html'">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <h5>Find Events</h5>
                </div>
                <div class="action-card" onclick="window.location.href='myevents.html'">
                    <i class="fas fa-calendar fa-2x mb-3"></i>
                    <h5>My Events</h5>
                </div>
                <div class="action-card" onclick="window.location.href='certificates.html'">
                    <i class="fas fa-certificate fa-2x mb-3"></i>
                    <h5>Certificates</h5>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-card">
                        <h4>Volunteer Hours</h4>
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h4>Impact Overview</h4>
                        <canvas id="impactChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="card-title mb-0">Upcoming Events</h4>
                        <a href="opportunities.html" class="btn btn-outline-primary btn-sm">
                            View All
                        </a>
                    </div>
                    <div id="latestEvents">
                    </div>
                </div>
            </div>
        </div>

        <div class="leaderboard-section mt-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-trophy"></i> Top Volunteers</h4>
                    <button class="btn btn-light btn-sm" id="refreshLeaderboard">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="top-volunteers mb-4">
                        <div class="row g-3" id="topThree">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Volunteer</th>
                                    <th>Hours</th>
                                    <th>Events</th>
                                    <th>Points</th>
                                    <th>Achievements</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="../config/firebaseConfig.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const elements = {
            volunteerName: document.getElementById('volunteerName'),
            totalHours: document.getElementById('totalHours'),
            eventsAttended: document.getElementById('eventsAttended'),
            totalPoints: document.getElementById('totalPoints'),
            badgesEarned: document.getElementById('badgesEarned'),
            latestEvents: document.getElementById('latestEvents'),
            hoursChart: document.getElementById('hoursChart'),
            impactChart: document.getElementById('impactChart'),
            topThree: document.getElementById('topThree'),
            leaderboardTable: document.getElementById('leaderboardTable'),
            refreshBtn: document.getElementById('refreshBtn'),
            refreshLeaderboard: document.getElementById('refreshLeaderboard'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Chart Management
        const charts = {
            async initialize() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    const hoursData = await this.getHoursData(user.uid);
                    const impactData = await this.getImpactData(user.uid);

                    this.createHoursChart(hoursData);
                    this.createImpactChart(impactData);
                } catch (error) {
                    console.error("Error initializing charts:", error);
                }
            },

            async getHoursData(userId) {
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

                const hoursSnapshot = await getDocs(query(
                    collection(db, "volunteerHours"),
                    where("userId", "==", userId),
                    where("date", ">=", sixMonthsAgo.toISOString()),
                    orderBy("date", "desc")
                ));

                const monthlyHours = new Map();
                const months = Array.from({ length: 6 }, (_, i) => {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    return date.toLocaleString('default', { month: 'short' });
                }).reverse();

                months.forEach(month => monthlyHours.set(month, 0));

                hoursSnapshot.forEach(doc => {
                    const data = doc.data();
                    const month = new Date(data.date).toLocaleString('default', { month: 'short' });
                    if (monthlyHours.has(month)) {
                        monthlyHours.set(month, monthlyHours.get(month) + (data.hours || 0));
                    }
                });

                return {
                    labels: months,
                    data: months.map(month => monthlyHours.get(month))
                };
            },

            async getImpactData(userId) {
                const eventsSnapshot = await getDocs(query(
                    collection(db, "eventParticipants"),
                    where("userId", "==", userId),
                    where("status", "==", "completed")
                ));

                const categoryCount = new Map();
                ['Education', 'Environment', 'Health', 'Community'].forEach(category =>
                    categoryCount.set(category, 0)
                );

                for (const doc of eventsSnapshot.docs) {
                    const eventDoc = await getDoc(doc(db, "events", doc.data().eventId));
                    if (eventDoc.exists()) {
                        const category = eventDoc.data().category || 'Other';
                        categoryCount.set(category, (categoryCount.get(category) || 0) + 1);
                    }
                }

                return {
                    labels: Array.from(categoryCount.keys()),
                    data: Array.from(categoryCount.values())
                };
            },

            createHoursChart(data) {
                const ctx = elements.hoursChart.getContext('2d');
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Volunteer Hours',
                            data: data.data,
                            borderColor: '#FF6B6B',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(255, 107, 107, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5 }
                            }
                        }
                    }
                });
            },

            createImpactChart(data) {
                const ctx = elements.impactChart.getContext('2d');
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            backgroundColor: ['#FF6B6B', '#4ECDC4', '#FFD93D', '#6C5CE7']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            }
        };

        // Dashboard Functions
        const dashboard = {
            async loadVolunteerData() {
                const user = auth.currentUser;
                if (!user) return;

                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        elements.volunteerName.textContent = userData.name || "Volunteer";
                        elements.totalHours.textContent = userData.totalHours || 0;
                        elements.eventsAttended.textContent = userData.eventsAttended || 0;
                        elements.totalPoints.textContent = userData.totalPoints || 0;
                        elements.badgesEarned.textContent = userData.badgesEarned || 0;
                    }
                } catch (error) {
                    console.error("Error loading volunteer data:", error);
                }
            },

            async loadLatestEvents() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    const today = new Date();
                    const snapshot = await getDocs(query(
                        collection(db, "events"),
                        where("status", "==", "active"),
                        where("date", ">=", today.toISOString()),
                        orderBy("date", "asc"),
                        limit(5)
                    ));

                    elements.latestEvents.innerHTML = snapshot.empty ?
                        this.getEmptyEventsTemplate() :
                        snapshot.docs.map(doc => this.getEventCardTemplate(doc.data())).join('');
                } catch (error) {
                    console.error("Error loading latest events:", error);
                }
            },

            getEmptyEventsTemplate() {
                return `
            <div class="text-center py-4">
                <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">No upcoming events available</p>
            </div>
        `;
            },

            getEventCardTemplate(event) {
                return `
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">${event.title}</h5>
                    <p class="card-text text-muted">
                        <i class="fas fa-calendar-alt me-2"></i>${new Date(event.date).toLocaleDateString()}
                    </p>
                    <p class="card-text text-muted">
                        <i class="fas fa-map-marker-alt me-2"></i>${event.location || "Location not specified"}
                    </p>
                </div>
            </div>
        `;
            }
        };

        // Event Listeners
        function setupEventListeners() {
            elements.refreshBtn.addEventListener('click', async () => {
                try {
                    await Promise.all([
                        dashboard.loadVolunteerData(),
                        dashboard.loadLatestEvents(),
                        charts.initialize()
                    ]);

                    Swal.fire({
                        icon: 'success',
                        title: 'Dashboard Updated',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error("Error refreshing dashboard:", error);
                }
            });

            elements.logoutBtn.addEventListener('click', async () => {
                try {
                    const result = await Swal.fire({
                        title: 'Are you sure?',
                        text: "You will be logged out of your account.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#FF6B6B',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Yes, logout'
                    });

                    if (result.isConfirmed) {
                        await signOut(auth);
                        await Swal.fire({
                            icon: 'success',
                            title: 'Logged Out',
                            text: 'You have been successfully logged out.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        window.location.href = '../home/signup.html';
                    }
                } catch (error) {
                    console.error("Logout error:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while logging out. Please try again.'
                    });
                }
            });
        }

        // Initialize
        function init() {
            setupEventListeners();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        await Promise.all([
                            dashboard.loadVolunteerData(),
                            dashboard.loadLatestEvents(),
                            charts.initialize()
                        ]);
                    } catch (error) {
                        console.error("Dashboard initialization error:", error);
                    }
                } else {
                    window.location.href = '../home/signup.html';
                }
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                console.log("Attempting to log out...");
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You will be logged out of your account.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#FF6B6B',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, logout'
                });

                if (result.isConfirmed) {
                    await signOut(auth); // Sign out the user
                    Swal.fire({
                        icon: 'success',
                        title: 'Logged Out',
                        text: 'You have been successfully logged out.',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    // Redirect to the login page
                    setTimeout(() => {
                        window.location.href = '../home/signup.html';
                    }, 1500);
                }
            } catch (error) {
                console.error("Logout error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while logging out. Please try again.'
                });
            }
        });

        // Start the application
        init();

    </script>
    
</body>

</html>