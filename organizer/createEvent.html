<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event - V-Connect</title>
    <link rel="icon" href="../assets/v1.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/organizer/createEvents.css">
</head>

<body>
   
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    <button id="mobileMenuToggle" class="btn btn-primary d-md-none position-fixed">
        <i class="fas fa-bars"></i>
    </button>
    <nav class="sidebar">
        <a href="organizerDashboard.html" class="sidebar-logo">
            <i class="fas fa-hands-helping"></i>
            <span>V-Connect</span>
        </a>
        <div class="nav flex-column">
            <a href="organizerDashboard.html" class="nav-link ">
                <i class="fas fa-home"></i>
                Dashboard
            </a>

            <a href="organizerProfile.html" class="nav-link">
                <i class="fas fa-user"></i>
                Profile
            </a>

            <a href="createEvent.html" class="nav-link active">
                <i class="fas fa-calendar-plus"></i>
                Create Event
            </a>

            <a href="manageEvents.html" class="nav-link">
                <i class="fas fa-tasks"></i>
                Manage Events
            </a>

            <a href="manageVolunteers.html" class="nav-link">
                <i class="fas fa-users"></i>
                Manage Volunteers
            </a>

            <a href="eventCompletion.html" class="nav-link">
                <i class="fas fa-check-circle"></i>
                Event Completion
            </a>

            <a href="#" class="nav-link" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <button id="mobileMenuToggle" class="btn btn-primary d-md-none position-fixed"
        style="top: 1rem; right: 1rem; z-index: 1001;">
        <i class="fas fa-bars"></i>
    </button>

    <div class="main-content">
        <div class="container">
            <div class="form-container">
                <h2 class="mb-4">Create New Event</h2>
                <form id="createEventForm" class="needs-validation" novalidate>
                    <div class="mb-4">
                        <h4>Basic Information</h4>
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Event Title*</label>
                            <input type="text" class="form-control" id="eventTitle" required minlength="5"
                                maxlength="100">
                            <div class="invalid-feedback">
                                Please provide an event title (5-100 characters)
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Event Description*</label>
                            <textarea class="form-control" id="eventDescription" rows="4" required minlength="20"
                                maxlength="500"></textarea>
                            <div class="invalid-feedback">
                                Please provide a description (20-500 characters)
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4>Date and Time</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventDate" class="form-label">Event Date*</label>
                                    <input type="date" class="form-control" id="eventDate" required>
                                    <div class="invalid-feedback">
                                        Please select a valid date
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventTime" class="form-label">Event Time*</label>
                                    <input type="time" class="form-control" id="eventTime" required>
                                    <div class="invalid-feedback">
                                        Please select a valid time
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4>Location and Category</h4>
                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Location*</label>
                            <input type="text" class="form-control" id="eventLocation" required>
                            <div class="invalid-feedback">
                                Please provide an event location
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="eventCategory" class="form-label">Category*</label>
                            <select class="form-control" id="eventCategory" required>
                                <option value="">Select a category</option>
                                <option value="environmental">Environmental</option>
                                <option value="education">Education</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="community">Community Service</option>
                                <option value="elderly">Elderly Care</option>
                                <option value="youth">Youth Development</option>
                                <option value="animals">Animal Welfare</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a category
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4>Volunteer Requirements</h4>
                        <div class="mb-3">
                            <label for="volunteerCount" class="form-label">Number of Volunteers Needed*</label>
                            <input type="number" class="form-control" id="volunteerCount" min="1" max="1000" required>
                            <div class="invalid-feedback">
                                Please enter a valid number (1-1000)
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="skillsRequired" class="form-label">Required Skills</label>
                            <input type="text" class="form-control" id="skillsRequired"
                                placeholder="Enter skills separated by commas">
                            <small class="text-muted">Optional: List skills that volunteers should have</small>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4>Event Image</h4>
                        <div class="mb-3">
                            <label for="eventImage" class="form-label">Upload Event Image</label>
                            <input type="file" class="form-control" id="eventImage" accept="image/*">
                            <small class="text-muted">Recommended size: 1200x630px, Max size: 5MB</small>
                            <div class="image-preview-container"> 
                                <img id="imagePreview" class="image-preview d-none">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus-circle me-2"></i>Create Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="../config/firebaseConfig.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const eventDate = document.getElementById('eventDate');
        const today = new Date().toISOString().split('T')[0];
        eventDate.min = today;

        const removeImageBtn = document.createElement('button');
        removeImageBtn.className = 'remove-image d-none';
        removeImageBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeImageBtn.onclick = function () {
            const imageInput = document.getElementById('eventImage');
            const imagePreview = document.getElementById('imagePreview');
            imageInput.value = '';
            imagePreview.classList.add('d-none');
            this.classList.add('d-none');
        };
        function resetForm() {
            const form = document.getElementById('createEventForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('imagePreview').classList.add('d-none');
            document.querySelector('.remove-image').classList.add('d-none');
        }
        document.querySelector('.image-preview-container').appendChild(removeImageBtn);

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type = 'error') {
            Swal.fire({
                icon: type,
                title: type === 'error' ? 'Error' : 'Success',
                text: message,
                timer: 3000,
                showConfirmButton: false
            });
        }
        document.getElementById('eventImage').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.querySelector('.remove-image') || createRemoveButton();

            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image size should be less than 5MB');
                    this.value = '';
                    preview.classList.add('d-none');
                    removeBtn.classList.add('d-none');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                    removeBtn.classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });

        function createRemoveButton() {
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image d-none';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function () {
                const imageInput = document.getElementById('eventImage');
                const imagePreview = document.getElementById('imagePreview');
                imageInput.value = '';
                imagePreview.classList.add('d-none');
                this.classList.add('d-none');
            };

            const container = document.querySelector('.image-preview-container');
            if (container) {
                container.appendChild(removeBtn);
            }

            return removeBtn;
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuBtn = document.getElementById('mobileMenuToggle');
            const sidebar = document.querySelector('.sidebar');

            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                });
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                console.log("Attempting to log out...");
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You will be logged out of your account.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#FF6B6B',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, logout'
                });

                if (result.isConfirmed) {
                    await signOut(auth); // Sign out the user
                    Swal.fire({
                        icon: 'success',
                        title: 'Logged Out',
                        text: 'You have been successfully logged out.',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    // Redirect to the login page
                    setTimeout(() => {
                        window.location.href = '../home/signup.html';
                    }, 1500);
                }
            } catch (error) {
                console.error("Logout error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while logging out. Please try again.'
                });
            }
        });

            try {
                await Swal.fire({
                    title: 'Are you sure?',
                    text: "You will be logged out of your account",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#FF6B6B',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, logout'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await auth.signOut();
                        window.location.href = '../home/signup.html';
                    }
                });
            } catch (error) {
                console.error("Logout error:", error);
                showAlert('Error signing out');
            }
        });

        document.getElementById('createEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');

                Swal.fire({
                    icon: 'warning',
                    title: 'Form Validation',
                    text: 'Please fill in all required fields correctly.',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }

    
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Event...';
            showLoading();

            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in to create an event');

                let imageUrl = '';
                const imageFile = document.getElementById('eventImage').files[0];
                if (imageFile) {
                    const storageRef = ref(storage, `events/${user.uid}/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                }

                const eventData = {
                    title: document.getElementById('eventTitle').value.trim(),
                    description: document.getElementById('eventDescription').value.trim(),
                    date: document.getElementById('eventDate').value,
                    time: document.getElementById('eventTime').value,
                    location: document.getElementById('eventLocation').value.trim(),
                    category: document.getElementById('eventCategory').value,
                    requiredVolunteers: parseInt(document.getElementById('volunteerCount').value),
                    skillsRequired: document.getElementById('skillsRequired').value
                        .split(',')
                        .map(skill => skill.trim())
                        .filter(skill => skill.length > 0),
                    imageUrl,
                    organizerId: user.uid,
                    status: 'upcoming',
                    registeredVolunteers: [],
                    createdAt: new Date().toISOString()
                };

                await addDoc(collection(db, "events"), eventData);

                await addDoc(collection(db, "notifications"), {
                    userId: user.uid,
                    title: "Event Created",
                    message: `Your event "${eventData.title}" has been created successfully.`,
                    type: "event_created",
                    read: false,
                    createdAt: new Date().toISOString()
                });

                await Swal.fire({
                    icon: 'success',
                    title: 'Event Created Successfully!',
                    text: 'Redirecting to dashboard...',
                    timer: 2000,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                window.location.href = 'organizerDashboard.html';

            } catch (error) {
                console.error("Error creating event:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Error creating event. Please try again.',
                    confirmButtonColor: '#FF6B6B'
                });
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Event';
            } finally {
                hideLoading();
            }
        });

        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = '../home/signup.html';
            }
        });
    </script>
</body>

</html>